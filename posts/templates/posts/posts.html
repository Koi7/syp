{% extends "posts/base.html" %}
{% load static from staticfiles %}
{% block extra_links %}
<link rel="stylesheet" type="text/css" href="{% static 'posts/styles/forms.css' %}">
{% endblock %}
{% block extra_scripts_head %}
	<script src="{% static 'posts/js/util.js' %}"></script>
{% endblock %}
{% block title %}Посты{% endblock %}

{% block content %}
	<!-- PAGE HEADER -->
	<h1 class="w3-padding-tiny w3-text-awesome w3-center">Посты</h1>
	<!-- FILTERS -->
	{% include "posts/filter_panel.html" %}	
	<!-- POST LIST -->
	<div id="posts_list">
{% if posts_list %}

{% for post in posts_list %}

{% include "posts/post_card.html" %}

{% endfor %}

{% else %}
        <div class="w3-container w3-padding-jumbo w3-center w3-text-gray">
            <h3>Нет постов пока.</h3>
            <span class="w3-jumbo">:(</span>
        </div>
{% endif %}
	</div>
	<!-- END POST LIST -->
{% endblock %}

{% block extra_scripts %}

<script type="text/javascript">

var toggleRate = 100;

function filter(place, tag_id, order, anonymous){
	$('#posts_list').html('Ожидайте...');
	$.ajax({
		type: "POST",
		url: "{% url 'posts_filter' %}", 			
		data: {
			place: place,
			tag: tag_id,
			order: order,
			anonymous: anonymous,
			csrfmiddlewaretoken: getCookie('csrftoken')
		},
		context: this,
		dataType: "json",
		success: function (data){
			if (data.success){
				$('#posts_list').html(data.rendered_template);
			} else{
				alert('error');
			}
		}
	});
}


function LikeEvent(){
	var post_id = $(this).data('post-id');
	$.ajax({
		type: "POST",
		url: "{% url 'like_post' %}", 			
		data: {
			post_id: post_id,
			csrfmiddlewaretoken: getCookie('csrftoken')
		},
		context: this,
		dataType: "json",
		success: function (data){
			if (data.is_created == '0'){
				$(this).removeClass('w3-text-gray');
				$(this).addClass('w3-text-red');
			} else{
				$(this).removeClass('w3-text-red');
				$(this).addClass('w3-text-gray');
			}
			$('span.likes-amount[data-post-id=' + post_id + ']').text(data.likes_amount);
		}
	});
}

function ClickSendButtonEventHandler(){
	var post_id = $(this).data('post-id');
	var input_value = $.trim($('input.w3-input[data-post-id=' + post_id + ']').val());
	if (input_value.length > 0){
		$(this).html('Отправляеться...');
		$(this).attr('disabled', true);
		$.ajax({
			type: "POST",
			url: "{% url 'leave_message' %}", 			
			data: {
				post_id: post_id,
				message: input_value,
				csrfmiddlewaretoken: getCookie('csrftoken')
			},
			context: this,
			dataType: "json",
			success: function (data){
				if (data.success){
					$(this).html('Отправлено <i class="fa fa-check" aria-hidden="true"></i>');
					// update post state on front end
					// make icon red
					$('i.fa-heart[data-post-id=' + post_id + ']').removeClass('w3-text-gray');
					$('i.fa-heart[data-post-id=' + post_id + ']').addClass('w3-text-red');
					// change amount of likes
					$('span.likes-amount[data-post-id=' + post_id + ']').text(data.amount);
				}else{
					$(this).html('Уже отправляли!');
				}
				//hide inputs
				$('footer[data-post-id=' + post_id + ']').delay(2500).hide(toggleRate);
			}
		});

	}
}

function ShowSendMessageControls(){
	var post_id = $(this).data('post-id');
	$('div.send-message-controls[data-post-id=' + post_id + ']').toggle(toggleRate);
}

$(document).on('click', '.fa-heart', LikeEvent);
$(document).on('click', 'span.message-sender', ClickSendButtonEventHandler);
$(document).on('click', 'i.show-send-message-controls', ShowSendMessageControls);

$(document).ready(function () {

	$('#filter_place').change(function () {
    	filter($(this).val(), $('#filter_tags').val(), $('#filter_order').val(), $('#filter_anonymous').val());
	});

	$('#filter_tags').change(function () {
	    filter($('#filter_place').val(), $(this).val(), $('#filter_order').val(), $('#filter_anonymous').val());
	});

	$('#filter_order').change(function () {
	    filter($('#filter_place').val(), $('#filter_tags').val(), $(this).val(), $('#filter_anonymous').val());
	});

	$('#filter_anonymous').change(function () {
	    filter($('#filter_place').val(), $('#filter_tags').val(), $('#filter_order').val(), $(this).val());
	});

	$('#filter_panel_toggler').click(function (){
		$('#filters').toggle(toggleRate);
	});

});
</script>

{% endblock %}